name: Import Issues from YAML

on:
  workflow_dispatch:
    inputs:
      file:
        description: "Path to YAML (e.g. ops/issues/m0-child-issues.yml)"
        required: true
        default: "ops/issues/m0-child-issues.yml"
      update_epic_checklists:
        description: "Update parent epic checklist items to link created issues"
        required: true
        default: "true"
        type: choice
        options:
          - "true"
          - "false"

permissions:
  issues: write

jobs:
  import:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install YAML parser
        run: npm install js-yaml

      - name: Create issues from YAML
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const yaml = require("js-yaml");

            const yamlPath = core.getInput("file");
            const updateEpicChecklists = (core.getInput("update_epic_checklists") || "true") === "true";

            if (!fs.existsSync(yamlPath)) {
              core.setFailed(`YAML file not found: ${yamlPath}`);
              return;
            }

            const doc = yaml.load(fs.readFileSync(yamlPath, "utf8"));
            const milestoneTitle = doc.milestone;
            const issues = doc.issues || [];

            if (!milestoneTitle) {
              core.setFailed("YAML is missing top-level 'milestone' field.");
              return;
            }

            // 1) Find milestone number by title
            const milestones = await github.paginate(github.rest.issues.listMilestones, {
              ...context.repo,
              state: "all",
              per_page: 100
            });

            const ms = milestones.find(m => m.title === milestoneTitle);
            if (!ms) {
              core.setFailed(`Milestone not found: "${milestoneTitle}"`);
              return;
            }

            // Helpers
            function mdList(items) {
              if (!items || items.length === 0) return "";
              return items.map(x => `- ${x}`).join("\n");
            }

            function mdChecklist(items) {
              if (!items || items.length === 0) return "";
              return items.map(x => `- [ ] ${x}`).join("\n");
            }

            function buildBody(item, epicIssueNumberOrNull) {
              const b = item.body || {};
              const lines = [];

              // Align with your templates (Feature/Chore/Tech-debt/Bug)
              if (item.type === "chore") {
                lines.push(`## Chore type\n${b.chore_type || "tooling (scripts, CI, automation)"}\n`);
              }

              if (item.type === "feature" || item.type === "chore") {
                lines.push(`## What\n${b.what || ""}\n`);
                lines.push(`## Why\n${b.why || ""}\n`);

                const dod = b.definition_of_done || [];
                lines.push(`## Definition of Done\n${mdChecklist(dod)}\n`);

                lines.push(`## System\n${b.system || ""}\n`);
                lines.push(`## Priority\n${b.priority || ""}\n`);

                if (b.notes) {
                  lines.push(`## Notes / links\n${b.notes}\n`);
                }
              } else {
                // Fallback (shouldn't happen for your M0 file)
                lines.push(`## Notes\nImported by workflow.\n`);
              }

              // Parent epic link
              if (item.parent_epic) {
                if (epicIssueNumberOrNull) {
                  lines.push(`## Parent Epic\n- #${epicIssueNumberOrNull}\n`);
                } else {
                  lines.push(`## Parent Epic\n- ${item.parent_epic}\n`);
                }
              }

              // Meta
              lines.push(`---\n**Area:** ${item.area || ""}  \n**Estimate:** ${item.estimate || ""}  \n**Risk:** ${item.risk || ""}\n`);

              return lines.join("\n").trim() + "\n";
            }

            async function findEpicByTitle(title) {
              if (!title) return null;

              // Search issues in repo by exact-ish title and epic label
              const q = `repo:${context.repo.owner}/${context.repo.repo} is:issue label:"type:epic" in:title "${title.replace(/"/g, '\\"')}"`;
              const res = await github.rest.search.issuesAndPullRequests({ q, per_page: 10 });

              // Prefer exact title match
              const exact = res.data.items.find(i => i.title === title);
              return exact || res.data.items[0] || null;
            }

            async function issueExistsWithSameTitle(title) {
              const q = `repo:${context.repo.owner}/${context.repo.repo} is:issue in:title "${title.replace(/"/g, '\\"')}"`;
              const res = await github.rest.search.issuesAndPullRequests({ q, per_page: 20 });
              return res.data.items.some(i => i.title === title);
            }

            async function linkIssueIntoEpicChecklist(epic, rawTitle, createdNumber) {
              // Replace first matching checklist line in epic body:
              // "- [ ] rawTitle"  => "- [ ] #123 rawTitle"
              const body = epic.body || "";
              const escaped = rawTitle.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
              const re = new RegExp(`^- \\[ \\] ${escaped}\\s*$`, "m");

              if (!re.test(body)) return false;

              const updated = body.replace(re, `- [ ] #${createdNumber} ${rawTitle}`);
              await github.rest.issues.update({
                ...context.repo,
                issue_number: epic.number,
                body: updated
              });
              return true;
            }

            core.info(`Importing ${issues.length} issues into milestone "${milestoneTitle}"...`);

            for (const item of issues) {
              const title = (item.title || "").trim();
              if (!title) continue;

              // Idempotency: skip if already exists
              if (await issueExistsWithSameTitle(title)) {
                core.info(`Skipping (already exists): ${title}`);
                continue;
              }

              let epic = null;
              if (item.parent_epic) {
                epic = await findEpicByTitle(item.parent_epic);
              }

              const labels = item.labels || [];

              const body = buildBody(item, epic ? epic.number : null);

              const created = await github.rest.issues.create({
                ...context.repo,
                title,
                body,
                milestone: ms.number,
                labels
              });

              core.info(`Created #${created.data.number}: ${title}`);

              // Optionally link into epic checklist
              if (updateEpicChecklists && epic && item.raw_title) {
                const ok = await linkIssueIntoEpicChecklist(epic, item.raw_title, created.data.number);
                if (ok) {
                  core.info(`Linked into epic checklist: ${epic.title} <- #${created.data.number}`);
                } else {
                  core.info(`No matching checklist line found in epic: ${epic.title} for "${item.raw_title}"`);
                }
              }
            }

            core.info("Done.");
          github-token: ${{ secrets.GITHUB_TOKEN }}
